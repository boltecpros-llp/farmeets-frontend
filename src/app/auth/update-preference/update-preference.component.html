<div class="container py-4" style="max-width:450px;">
  <!-- Step 1: Language Selection -->
  <div *ngIf="step === 1" class="stepper-step animate__animated animate__fadeIn">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <button class="btn btn-link" (click)="skip()">Skip</button>
      <h4 class="mb-3 flex-grow-1 text-center">Select Language(s)</h4>
      <button class="btn btn-primary" [disabled]="selectedLanguages.length === 0"
        (click)="fetchCategories()">Next</button>
    </div>
    <div class="row g-2">
      <div class="col-6 col-sm-4" *ngFor="let lang of languages">
        <div class="card text-center p-2" (click)="selectLanguage(lang)"
          [class.border-success]="isLanguageSelected(lang.id)" [class.bg-success-subtle]="isLanguageSelected(lang.id)"
          style="cursor:pointer;">
          <div class="ratio ratio-1x1 d-flex align-items-center justify-content-center"
            [style.backgroundColor]="getColor(lang.isoCode)">
            <span class="fs-1 w-100 h-100 d-flex align-items-center justify-content-center lang-text">{{ lang.icon ||
              LANGUAGE_MAP[lang.isoCode] || lang.name }}</span>
          </div>
          <div class="mt-2 fw-bold lang-label">{{ lang.name }}</div>
        </div>
      </div>
    </div>
    <div *ngIf="loadingLanguages" class="small text-muted text-center mt-3">Loading languages...</div>
    <div class="d-flex justify-content-between">
      <button class="btn btn-link mt-3" (click)="skip()">Skip</button>
      <button class="btn btn-primary ms-auto mt-3" [disabled]="selectedLanguages.length === 0"
        (click)="step = 2; fetchCategories();">Next</button>
    </div>
  </div>

  <!-- Step 2: Category Selection -->
    <div *ngIf="step === 2" class="stepper-step animate__animated animate__fadeIn">
      <div class="d-flex align-items-center mb-2">
        <h4 class="mb-3 flex-grow-1">Select Category</h4>
        <button class="ms-auto btn btn-primary" [disabled]="selectedCategories.length === 0"
          (click)="savePreferences()">Save</button>
      </div>
      <div class="mb-3">
        <input type="text" class="form-control" placeholder="Search categories..." [value]="categorySearch" (input)="onCategorySearchChange($event)">
      </div>
      <div *ngIf="loadingCategories" class="small text-muted text-center">Loading categories...</div>
      <div class="row g-2">
        <div class="col-12" *ngFor="let cat of filteredCategories">
          <div class="card p-2 mb-2" style="cursor:pointer;">
            <div class="d-flex align-items-center start">
              <div class="w-25 ratio ratio-4x3 me-2">
                <img [src]="cat.images && cat.images[0] || cat.image" alt="Category" class="object-fit-cover">
              </div>
              <div class="fw-bold clamp-2">{{ cat.names?.[selectedLanguages[0]?.isoCode] || cat.names?.['en'] || cat.name }}
              </div>
            </div>
            <div *ngIf="cat.children?.length" class="mt-2 ms-4">
              <div class="row g-1">
                <div class="col-6" *ngFor="let sub of cat.children">
                  <div class="card p-1 d-flex flex-row align-items-center"
                    (click)="$event.stopPropagation(); selectCategory(sub)"
                    [class.border-success]="isCategorySelected(sub.id)"
                    [class.bg-success-subtle]="isCategorySelected(sub.id)" style="cursor:pointer;">
                    <div class="w-25 ratio ratio-4x3 me-2">
                      <img [src]="sub.images && sub.images[0] || sub.image" alt="Sub Category" class="object-fit-cover">
                    </div>
                    <div class="clamp-2">{{ sub.names?.[selectedLanguages[0]?.isoCode] || sub.names?.['en'] || sub.name }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="d-flex justify-content-end mt-3">
        <button class="btn btn-primary" [disabled]="selectedCategories.length === 0"
          (click)="savePreferences()">Save</button>
        <button class="btn btn-link ms-2" (click)="skip()">Skip</button>
      </div>
    </div>
</div>